<!-- Ładowanie ajaxem -->
<%if (!isAdminLogged) {%>
<h1 class="liveHeader">KLASYFIKACJA</h1>
<h1 class="czatHeader">CZAT ONLINE</h1>
<% } else {%>
<h1 class="liveHeader">WPROWADŹ DANE</h1>
<h1 class="czatHeader">KLASYFIKACJA</h1>
<% } %>
<div id="liveWrapper">
		<div id="leftColumn">
			<%if (!isAdminLogged) {%>
			<div id="headerLiveRelation" style="width:483px;">
			   <div class="columnKlasyf" style='width: 18px'>#</div>
			   <div class="columnKlasyf" style='width: 140px'>Skoczek</div>
			   <div class="columnKlasyf" style='width: 30px; padding-left: 0px'>Kraj</div>
			   <div class="columnKlasyf" style='width: 70px; padding-left: 12px'>Skok</div>
			   <div class="columnKlasyf" style='width: 100px'>Nota</div>
			</div>
			<div id="liveRelation" style="font-size: small; width: 483px;">
			</div>
			<% } %>
		</div>

		<div id="rightColumn">
			<%if (isAdminLogged) {%>
			<div id="privateMessage">
			    <div id="nickname"></div>
			    <div id="pm"></div>
			</div>
			<div id="headerLiveRelation" style="width:483px;">
			   <div class="columnKlasyf" style='width: 18px'>#</div>
			   <div class="columnKlasyf" style='width: 140px'>Skoczek</div>
			   <div class="columnKlasyf" style='width: 30px; padding-left: 0px'>Kraj</div>
			   <div class="columnKlasyf" style='width: 70px; padding-left: 12px'>Skok</div>
			   <div class="columnKlasyf" style='width: 100px'>Nota</div>
			</div>
			<div id="liveRelation" style="font-size: small; width: 483px;">
			</div>
			<% } %>
		</div>
</div>
		<div id="postWrapper">
		    
		    <div id="postLeft">
			<%if (isAdminLogged) {%>
			<div id="headerInput">Skoczek</div>
			<div id="headerInput" style="width: 65px;">Kraj</div>
			<div id="headerInput" style="width: 65px;">Skok</div>
			<div id="headerInput" style="width: 65px;">Nota</div>
			<div id="headerInput" style="width: 65px;">Wiatr</div>
		    <textarea id="adminMsg" rows="" cols="" style="margin-bottom: -15px;" ></textarea>
		    <select id="adminMsg5">
			<script>
			        var kraje = new Array('AUT','SLO','GER','POL','JPN','FIN','RUS','NOR','ITA','GRE','FRA','CHN','CZE','UKR','USA','SUI','KOR','BUL');
				kraje.sort();
			        for (var i=kraje.length-1;i>=0;i--) {
			        if ( kraje[i]=="POL" ) {
			        $('#adminMsg5').prepend('<option val="'+kraje[i]+'" selected>'+kraje[i]+'</option>');					
			        } else {
			        $('#adminMsg5').prepend('<option val="'+kraje[i]+'">'+kraje[i]+'</option>');
				}
				}
			</script>
		    </select>
		    <select id="adminMsg2">
			<script>
			        for (var i=55;i<=150;i++) {
			        if ( i==120 ) {
			        $('#adminMsg2').prepend('<option val="'+i+'" selected>'+i+'</option>');
				$('#adminMsg2').prepend('<option val="'+(i+0.5)+'">'+(i+0.5)+'</option>');					
			        } else {
			        $('#adminMsg2').prepend('<option val="'+i+'">'+i+'</option>');
				$('#adminMsg2').prepend('<option val="'+(i+0.5)+'">'+(i+0.5)+'</option>');
				}
				}
			</script>
		    </select>
		    <select id="adminMsg3">
			<script>
			        for (var i=0;i<=60;i++) {
			        if ( i==54 ) {
			        $('#adminMsg3').prepend('<option val="'+i+'" selected>'+i+'</option>');
				$('#adminMsg3').prepend('<option val="'+(i+0.5)+'">'+(i+0.5)+'</option>');					
			        } else {
			        $('#adminMsg3').prepend('<option val="'+i+'">'+i+'</option>');
				$('#adminMsg3').prepend('<option val="'+(i+0.5)+'">'+(i+0.5)+'</option>');
				}
				}
			</script>
		    </select>
		    <select id="adminMsg4">
			<script>
			        for (var i=0;i<=300;i++) {
			        if ( i==150 ) {
			        $('#adminMsg4').prepend('<option val="'+(i-150)+'" selected>'+(i-150)+'</option>');					
			        } else {
			        $('#adminMsg4').prepend('<option val="'+((-1.5+(i*0.01))).toFixed(2)+'">'+((-1.5+(i*0.01))).toFixed(2)+'</option>');
				}
				}
			</script>
		    </select>
		    <br><br>
		    
			<a id="sendLeft" href="#">wyślij</a>
			<a id="destroy" href="#">usuń</a>
			<%} else {%>
			<div id="headerInput">Napisz do admina</div>
			<textarea rows="" id="pmToAdmin" cols="" ></textarea>
			<br><br>
			<a id="sendPMToAdmin" href="#">wyślij</a>
			<% } %>
		    </div>
		    
                    <div id="postRight">
			<%if (!isAdminLogged) {%>
			<div id="headerInput">Wpisz wiadomość</div>
			<textarea rows="" id="userMsg" cols="" ></textarea>
			<br><br>
			<a id="sendRight" href="#">wyślij</a>
			<% } else { %>
			<div id="headerInput">Odpowiedz użytkownikowi</div>
			<textarea rows="" id="adminResponse" cols="" ></textarea>
			<br><br>
			<a id="answerToUser" href="#">wyślij</a>
			<% } %>
		    </div>
		
		<script>
		
		$(document).ready(function(){

  h = $(window).height();
  
  $('#liveWrapper').css({height:(h-($('#header').height()*2)-$('#postWrapper').height()-$('#liveHeader').height())});
  
  });
  
  resizeElements = function(){
  
  h = $(window).height();
  $('#liveWrapper').css({height:(h-($('#header').height()*2)-$('#postWrapper').height()-$('#liveHeader').height())});
  };
	$(window).on('resize',resizeElements);		
			var socket = io.connect("localhost:3000");
			<%if (isAdminLogged) {%>
			$('#privateMessage').hide();
			adminSendMsg = function(jumper,jump,points,wind,nation)
			    {
			    if ( +jump > 120 ){
			          jumpPoints = ((+jump - 120)*1.8+60+(+points)+(wind*10)).toFixed(1);
			    } else if ( +jump < 87 ){
			          jumpPoints = ((+points)+(wind*10)).toFixed(1);	
			    }
			    else {
			          jumpPoints = ((120 - (+jump))*(-1.8)+60+(+points)+(wind*10)).toFixed(1);	
			    };
			    socket.emit('adminChannel', jumper,jump,jumpPoints,nation);
			    }
			$('#sendLeft').click(function(){
			    var jumper = $('#adminMsg').val();
			    var jump = $('#adminMsg2').val();
			    var points = $('#adminMsg3').val();
			    var wind = $('#adminMsg4').val();
			    var nation = $('#adminMsg5').val();
			    var pattern = /^[A-ZĆŁŹŻ][a-ząćęłńóśźż]{1,}\s[A-ZĆŁŹŻ][a-ząćęłńóśźż]{1,}$/g;
			    var TrueOrFalse = pattern.test(jumper);
			    if ( TrueOrFalse) {
						adminSendMsg(jumper,jump,points,wind,nation);
			    } else {
						$('#adminMsg').css('background-color', '#FA6A6A');
						window.setTimeout(function(){
						$('#adminMsg').css('background-color', '#FFFFFF');
						}, 2500);
			    }
			});
			$('#destroy').click(function(){
				var potwierdzenie = confirm("Jesteś pewny?");
				if ( potwierdzenie == true) {
			           socket.emit('destroyTable');
				}
			});
			$('#adminMsg').keyup(function(e){
			    if(e.which == 13) {
			    var jumper = $('#adminMsg').val();
			    var jump = $('#adminMsg2').val();
			    var points = ('#adminMsg3').val();
			    var wind = ('#adminMsg4').val();
			    var nation = ('#adminMsg5').val();
			    adminSendMsg(jumper,jump,points,wind,nation);
			    }
			});
			<%}%>
			
			var podswietl_dodany_element = function(co_podswietlic){
			    co_podswietlic.addClass('highlightPost');
			    window.setTimeout(function() {
			    co_podswietlic.removeClass('highlightPost');
			    }, 2500);
			};
			
			var ustaw_przeplatanie_kolorow = function(){
				if ($('#liveRelation .liveRelationRow:even').hasClass('highlightOdd')) {
			            $('#liveRelation .liveRelationRow:even').removeClass('highlightOdd');		
			        }
			        $('#liveRelation .liveRelationRow:odd').addClass('highlightOdd');		
			};
			
			var gdzieWstawic;
			socket.removeListener('adminMsg');
			socket.on('adminMsg', function(dane) {
			    var punkty = $('.liveRelationRow').first();
			    gdzieWstawic = $('.liveRelationRow').first();
			    var ilZawodnikow, rank;
			    if ($('.liveRelationRow').length > 0) {
			        for (var i=0;i<70;i++) {
			             if (punkty.find('div .points').text() != "") {
			                  if ( +punkty.find('.points').text() <= +dane.points) {
						rank = $(gdzieWstawic).find('.rank').text();
						$(gdzieWstawic).hide().before('<div class="liveRelationRow"><div class="liveDescription"><div class="rank">'+rank+'</div><div class="kolumna" style="width: 140px">'+dane.jumper+'</div><div class="nation"><img src="../graph/nat/'+dane.nation+'.gif"></div><div class="kolumna" style="width: 70px">'+dane.jump+'</div><div class="points" style="width: 100px" value="'+dane.points+'">'+dane.points+'</div></div></div>');
						$(gdzieWstawic).hide().slideDown();
						ustaw_przeplatanie_kolorow();
						ilZawodnikow = $('.rank').length;
						rank = $('.liveRelationRow').first();
						for ( var j=1; j<=ilZawodnikow; j++) {
						    rank.find('.rank').text(j);
						    rank = rank.next();
						};
						podswietl_dodany_element($(gdzieWstawic).prev());
					        i=70;
					  }
					  else {
				                punkty = punkty.next();
					        gdzieWstawic = gdzieWstawic.next();
			               }
				     } else { // nie podswietla jak ostatni div dodaje
						var rank = $('.liveRelationRow').length;
						$('<div class="liveRelationRow"><div class="liveDescription"><div class="rank">'+(rank+1)+'</div><div class="kolumna" style="width: 140px">'+dane.jumper+'</div><div class="nation"><img src="../graph/nat/'+dane.nation+'.gif"></div><div class="kolumna" style="width: 70px">'+dane.jump+'</div><div class="points" style="width: 100px" value="'+dane.points+'">'+dane.points+'</div></div></div>').hide().appendTo('#liveRelation').slideDown();
			                        ustaw_przeplatanie_kolorow();
						podswietl_dodany_element($('.liveRelationRow').last());

						i=70;
			             } 
			        }
			     } 
				else {
			                 $('<div class="liveRelationRow"><div class="liveDescription"><div class="rank">'+1+'</div><div class="kolumna" style="width: 140px">'+dane.jumper+'</div><div class="nation"><img src="../graph/nat/'+dane.nation+'.gif"></div><div class="kolumna" style="width: 70px">'+dane.jump+'</div><div class="points" style="width: 100px" value="'+dane.points+'">'+dane.points+'</div></div></div>').hide().prependTo('#liveRelation').slideDown();
			                 podswietl_dodany_element($('.liveRelationRow').first());
				     };
			 });
			
			// ładowanie poprzednich postow
			socket.emit('loadAdminPosts', 'load');
			socket.removeListener('adminMsgs');
			socket.on('adminMsgs', function(listaDanych) {
			    for (var i=0;i<listaDanych.length;i++) {
				if (listaDanych[i].points){
				$('#liveRelation').append('<div class="liveRelationRow"><div class="liveDescription"><div class="rank">'+(i+1)+'</div><div class="kolumna" style="width: 140px">'+listaDanych[i].jumper+'</div><div class="nation"><img src="../graph/nat/'+listaDanych[i].nation+'.gif"></div><div class="kolumna" style="width: 70px">'+listaDanych[i].jump+'</div><div class="points" style="width: 100px" value="'+listaDanych[i].points+'">'+listaDanych[i].points+'</div></div></div>');
				}
			    }
			    $('#liveRelation .liveRelationRow:odd').addClass('highlightOdd');
			});
						
			// usuwanie danych z klasyfikacji
			socket.removeListener('truncateTable');
			socket.on('truncateTable', function(){
				$('#liveRelation > div').remove();
			});
			
			userSendToAdmin = function(msg){
			    sendInfo = {message: msg, nick: '<%= userNick %>'};
			    socket.emit('pmToAdmin', sendInfo);
			    $('#pmToAdmin').val('');
			}
			$('#sendPMToAdmin').click(function(){
			    userSendToAdmin($('#pmToAdmin').val());
			});
			$('#pmToAdmin').keyup(function(e){
			    if(e.which == 13) {
			    userSendToAdmin($('#pmToAdmin').val());
			    }
			});
			
			socket.removeListener('showToAdmin');
			socket.on('showToAdmin', function(dane) {
			var currentName = '<%= userNick %>'; 
			if ( currentName == 'Admin') {
			var shortMessage = dane.message.substring(0, dane.message.length > 30 ? 30 : dane.message.length) + (dane.message.length > 30 ? '...' : '');
			    $('#nickname').text(dane.nick);
			    $('#pm').text(shortMessage);
			    $('#privateMessage').slideDown().addClass('highlightPost');
			    window.setTimeout(function() {
			    $('#privateMessage').removeClass('highlightPost');
			    $('#privateMessage').slideUp();
			    }, 2500);
			}
			});
			
			responseToUser = function(msg){
			    sendInfo = {message: msg, nick: $('#nickname').text()};
			    socket.emit('adminResponse', sendInfo);
			    $('#adminResponse').val('');
			};
			$('#answerToUser').click(function(){
			    responseToUser($('#adminResponse').val());
			});
			$('#adminResponse').keyup(function(e){
			    if(e.which == 13) {
			    responseToUser($('#adminResponse').val());
			    }
			});
			
			socket.removeListener('responseToUser');
			socket.on('responseToUser', function(dane) {
			   var currentName = '<%= userNick %>'; 
			   if ( currentName == dane.nick) {
			       $('<div class="userPost"><div class="cloud">'+dane.message+'</div><div class="cloudDynks"></div><div class="userData"><div class="nick">Admin</div><div class="PostTime">'+dane.time+'</div></div></div>').hide().prependTo('#rightColumn').slideDown();
			   }
			});
			
			userNick = 'Test';
			userSendMsg = function(msg)
			    {
			    sendInfo = {message: msg, nick: '<%= userNick %>'};
			    socket.emit('usersChannel', sendInfo);
			    $('#userMsg').val('');
			    }
			$('#sendRight').click(function(){
			    userSendMsg($('#userMsg').val());
			});
			$('#userMsg').keyup(function(e){
			    if(e.which == 13) {
			    userSendMsg($('#userMsg').val());
			    }
			});
			socket.removeListener('userMsg');
			socket.on('userMsg', function(dane) {
			<%if (!isAdminLogged) {%>
			    $('<div class="userPost"><div class="cloud">'+dane.message+'</div><div class="cloudDynks"></div><div class="userData"><div class="nick">'+dane.nick+'</div><div class="PostTime">'+dane.time+'</div></div></div>').hide().prependTo('#rightColumn').slideDown();
			<%}%>
			});
			
			// ładowanie poprzednich postow
			socket.emit('loadChatPosts', 'load');
			socket.removeListener('chatPosts');
			socket.on('chatPosts', function(listaDanych) {
			<%if (!isAdminLogged) {%>
			    listaDanych.forEach(function(dane){
				if (dane.time)
				$('#rightColumn').append('<div class="userPost"><div class="cloud">'+dane.message+'</div><div class="cloudDynks"></div><div class="userData"><div class="nick">'+dane.nick+'</div><div class="PostTime">'+dane.time.substring(11,16)+'</div></div></div>');
			    });
			<%}%>
			});

			
			
		</script>